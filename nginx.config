server {
    if ($host = mcp.backyardbrains.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


  listen 80;
  server_name mcp.backyardbrains.com;
  return 301 https://$host$request_uri;


}

server {
  listen 443 ssl;
  http2 on;

  server_name mcp.backyardbrains.com;

  # Optional: small cap for safety
  client_max_body_size 1m;

  # Route all /auth/* to the MCP server for OAuth flow
  location /auth/ {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_read_timeout 300s;
    proxy_pass http://127.0.0.1:8087;
  }

  # Static assets (served directly without hitting the app)
  location / {
    alias /var/www/mcp.backyardbrains.com/static/;
  }

  # GitHub webhook for app deployment
  location /github-hook/ {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_pass http://127.0.0.1:9000/hooks/github-mcp-deploy;
  }

  # Health check (optional explicit path)
  location = /xero/healthz {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://127.0.0.1:8087;
  }

  # Route all /xero* requests (with or without trailing slash) to the MCP server
  location /xero {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_read_timeout 300s;
    proxy_pass http://127.0.0.1:8087;
  }

  # Health check (optional explicit path)
  location = /metabase/healthz {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://127.0.0.1:8087;
  }

  # Route all /metabase/* to the MCP server
  location /metabase/ {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_read_timeout 300s;
    proxy_pass http://127.0.0.1:8087;
  }

  # Forward all .well-known requests to the MCP server unchanged
  location ^~ /.well-known/ {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_read_timeout 300s;
    proxy_pass http://127.0.0.1:8087;
    add_header Cache-Control "no-store" always;
  }

    ssl_certificate /etc/letsencrypt/live/mcp.backyardbrains.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/mcp.backyardbrains.com/privkey.pem; # managed by Certbot
}